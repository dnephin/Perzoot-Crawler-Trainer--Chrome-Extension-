<html>
  <script src="jquery.min.js"></script>
  <script>

var VERSION = 0.1;

// List of configurable options
var OPTION_NAME_LIST = [
	'identification_string', 
	'listing_key', 
	'posting_key',
	'junk_key',
	'link_toggle_key',
	'upload_hostname'
];

/*
 * Channel Listener.
 */
chrome.extension.onConnect.addListener(function(port) {
	console.log('connection ' + port.name);
	if (port.name != 'background_channel') {
		console.log('ignoring channel ' + port.name);
		return;
	}
	
	port.onMessage.addListener(function(msg) {

		console.log('background received ' + msg.action);
	
		if (msg.action == 'getHTML') {
			$.ajax({
				'url': msg.page,
				'dataType': 'html',
				'type': 'get',
				'success': function(data) {
					port.postMessage({
						'response': msg.action, 'page': msg.page, 'data': data
					});
				}
			});
		}
	
		if (msg.action == 'getOptions') {
			var options = {};
			$.each(OPTION_NAME_LIST, function(index, name) {
				options[name] = localStorage[name];
			});
			port.postMessage({'response': msg.action, 'options': options});
		}

		if (msg.action == 'sendData') {
			var data = {
				'version': VERSION,
				'data': msg.data
			}
//			$.ajax('http://localhost:8080', request.data, function(data) {
//			});
			alert(data);
			port.postMessage({
				'response': msg.action, 'success': true,
			});
		}
	});
});


chrome.browserAction.setBadgeText({'text': 'off'});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	// TODO: move to onClick
//		chrome.tabs.executeScript(tabId, {file:"jquery.min.js"});
//		chrome.tabs.executeScript(tabId, {file:"link_menu.js"});
//		chrome.tabs.insertCSS(tabId, {file:"link_menu.css"});
});

chrome.browserAction.onClicked.addListener(function(tab) {
	// TODO: toggle off
	// TODO: save state after click
	chrome.tabs.executeScript(tab.id, {file:"jquery.min.js"});
	chrome.tabs.executeScript(tab.id, {file:"link_menu.js"});
	chrome.tabs.insertCSS(tab.id, {file:"link_menu.css"});

	chrome.browserAction.setBadgeText({'text': 'on', 'tabId': tab.id});
});

</script>
</html>

